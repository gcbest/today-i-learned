version: 2.1
executors:
  node-16:
    docker:
      - image: gcbest/cimg-pnpm
restore_pnpm_cache: &restore_pnpm_cache
  restore_cache:
    key: v1-deps-{{ checksum "pnpm-lock.yaml" }}
save_pnpm_cache: &save_pnpm_cache
  save_cache:
    key: v1-deps-{{ checksum "pnpm-lock.yaml" }}
    paths: 
      - node_modules
restore_next_build_cache: &restore_next_build_cache
  restore_cache:
    key: next-build-deps-{{ checksum "pnpm-lock.yaml" }}
save_next_build_cache: &save_next_build_cache
  save_cache:
    key: next-build-deps-{{ checksum "pnpm-lock.yaml" }}
    paths: 
      - ./.next/cache
install_railway: &install_railway
  run:
    name: Install Railway
    command: npm i -g @railway/cli
only_main_branch: &only_main_branch
  branches:
    only:
      - main

jobs:
  lint:
    executor: node-16
    steps:
      - checkout
      - *restore_pnpm_cache
      - run:
          name: Lint Styles 
          command: pnpx eslint . --ext .js,.jsx,.ts,.tsx
      - *save_pnpm_cache
  test_unit_integration:
    executor: node-16
    steps:
      - checkout
      - *restore_pnpm_cache
      - run: 
          name: Install Packages
          command: pnpm install
      - *save_pnpm_cache
      - run:
          name: Unit & Integration
          command: pnpm test
  test_e2e:
    docker:
      - image: mcr.microsoft.com/playwright:v1.23.1-focal
    environment:
        NODE_ENV: development # Needed if playwright is in `devDependencies`
    steps:
      - checkout
      - *restore_pnpm_cache
      - run: 
          name: Install Packages
          command: |
              npx playwright install
              npm install
      - *save_pnpm_cache
      - run:
          name: End to End
          command: npm run test:e2e
  deploy_staging:
    executor: node-16
    steps:
      - checkout
      - *install_railway
      - *restore_next_build_cache
      - run:
          name: Deploy
          command: RAILWAY_TOKEN=${RAILWAY_TOKEN_STAGING} railway up
      - *save_next_build_cache
  deploy_production:
    executor: node-16
    steps:
      - checkout
      - *install_railway
      - *restore_next_build_cache
      - run:
          name: Deploy
          command: RAILWAY_TOKEN=${RAILWAY_TOKEN_PRODUCTION} railway up
      - *save_next_build_cache

workflows:
  lint_test_deploy:
    jobs:
      - lint
      - test_unit_integration:
          requires:
            - lint
      - test_e2e:
          requires:
            - lint
      - deploy_staging:
          requires:
            - test_e2e
            - test_unit_integration
          filters:
            branches:
              only:
                - develop
      - hold:
          requires:
            - deploy_staging
          type: approval
          filters:
            *only_main_branch
      - deploy_production:
          requires:
            - hold
          filters:
            *only_main_branch